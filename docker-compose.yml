x-app-base: &app-base
  restart: always
  env_file:
    - .env
  labels:
    - traefik.enable=true
    - traefik.http.routers.auth_microservice.rule=Host(`${AUTH_MICROSERVICE_TRAEFIK_HOST:-auth_microservice.localhost}`)
    - traefik.http.routers.auth_microservice.entrypoints=http
    - traefik.http.routers.auth_microservice.service=auth_microservice
    - traefik.http.services.auth_microservice.loadbalancer.server.port=${AUTH_MICROSERVICE_PORT:-8000}
  networks:
    - default
    - traefik-shared
  depends_on:
    db:
      condition: service_healthy
    redis:
      condition: service_healthy
    rmq:
      condition: service_healthy
    mongo:
      condition: service_healthy
  environment:
    AUTH_MICROSERVICE_HOST: 0.0.0.0
    AUTH_MICROSERVICE_DB_HOST: auth_microservice-db
    AUTH_MICROSERVICE_DB_PORT: 5432
    AUTH_MICROSERVICE_DB_USER: ${AUTH_MICROSERVICE_DB_USER:-auth_microservice}
    AUTH_MICROSERVICE_DB_PASS: ${AUTH_MICROSERVICE_DB_PASS:-auth_microservice}
    AUTH_MICROSERVICE_DB_BASE: ${AUTH_MICROSERVICE_DB_BASE:-auth_microservice}
    AUTH_MICROSERVICE_RABBIT_HOST: auth_microservice-rmq
    AUTH_MICROSERVICE_REDIS_HOST: auth_microservice-redis
    AUTH_MICROSERVICE_MONGODB_URI: mongodb://auth_microservice-mongo:27017
    AUTH_MICROSERVICE_MONGODB_DATABASE: auth_documents

services:
  api:
    <<: *app-base
    build:
      context: .
      dockerfile: ./Dockerfile
    image: auth_microservice:${AUTH_MICROSERVICE_VERSION:-latest}
    ports:
      - "8000:8000"

  taskiq-worker:
    <<: *app-base
    image: auth_microservice:${AUTH_MICROSERVICE_VERSION:-latest}
    labels: []
    ports: []
    command:
      - taskiq
      - worker
      - auth_microservice.tkq:broker

  db:
    image: postgres:16.3-bullseye
    hostname: auth_microservice-db
    environment:
      POSTGRES_PASSWORD: "${AUTH_MICROSERVICE_DB_PASS:-auth_microservice}"
      POSTGRES_USER: "${AUTH_MICROSERVICE_DB_USER:-auth_microservice}"
      POSTGRES_DB: "${AUTH_MICROSERVICE_DB_BASE:-auth_microservice}"
    volumes:
      - auth_microservice-db-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    restart: always
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U ${AUTH_MICROSERVICE_DB_USER:-auth_microservice}
      interval: 2s
      timeout: 3s
      retries: 40

  migrator:
    <<: *app-base
    image: auth_microservice:${AUTH_MICROSERVICE_VERSION:-latest}
    command: alembic upgrade head
    restart: "no"
    labels: []
    ports: []
    depends_on:
      db:
        condition: service_healthy

  redis:
    image: bitnami/redis:6.2.5
    hostname: "auth_microservice-redis"
    restart: always
    environment:
      ALLOW_EMPTY_PASSWORD: "yes"
    healthcheck:
      test: redis-cli ping
      interval: 1s
      timeout: 3s
      retries: 50

  rmq:
    image: rabbitmq:3.9.16-management-alpine
    hostname: "auth_microservice-rmq"
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: "guest"
      RABBITMQ_DEFAULT_PASS: "guest"
      RABBITMQ_DEFAULT_VHOST: "/"
    healthcheck:
      test: rabbitmq-diagnostics check_running -q
      interval: 3s
      timeout: 3s
      retries: 50

  rabbitmq-exporter:
    image: kbudde/rabbitmq-exporter:1.0.0
    environment:
      RABBIT_URL: "http://auth_microservice-rmq:15672"
      RABBIT_USER: "guest"
      RABBIT_PASSWORD: "guest"
    ports:
      - "9419:9419"
    depends_on:
      rmq:
        condition: service_started
    restart: always

  redis-exporter:
    image: oliver006/redis_exporter:v1.61.0
    command:
      - "--redis.addr=redis://auth_microservice-redis:6379"
    ports:
      - "9121:9121"
    depends_on:
      redis:
        condition: service_healthy
    restart: always

  mongo:
    image: mongo:6.0
    hostname: "auth_microservice-mongo"
    restart: always
    ports:
      - "27018:27017"
    volumes:
      - auth_microservice-mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 3s
      retries: 20

  prometheus:
    image: prom/prometheus:v2.53.0
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
    volumes:
      - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./deploy/prometheus/alerts.yml:/etc/prometheus/rules/alerts.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    restart: always
    depends_on:
      api:
        condition: service_started

  grafana:
    image: grafana/grafana:10.4.3
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./deploy/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./deploy/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./deploy/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"
    restart: always
    depends_on:
      prometheus:
        condition: service_started

volumes:
  auth_microservice-db-data:
    name: auth_microservice-db-data
  auth_microservice-mongo-data:
    name: auth_microservice-mongo-data
  prometheus-data:
    name: auth_microservice-prometheus-data
  grafana-data:
    name: auth_microservice-grafana-data

networks:
  traefik-shared:
    name: traefik-shared
